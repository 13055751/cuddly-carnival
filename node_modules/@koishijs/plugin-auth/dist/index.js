import{useStorage as Y,store as m,send as $,Schema as I,message as z,useConfig as q,icons as B,router as j,pick as Z,deepEqual as ee}from"@koishijs/client";import{ref as M,defineComponent as H,resolveComponent as g,createElementBlock as _,openBlock as i,Fragment as S,createElementVNode as r,unref as p,toDisplayString as h,createVNode as u,withCtx as c,createTextVNode as w,createCommentVNode as N,withKeys as R,withModifiers as F,createBlock as O,computed as T,renderList as W,isRef as G,h as te,watch as E}from"vue";import{useRouter as oe}from"vue-router";const s=Y("auth",2,()=>({authType:0})),L=M(false),D=M(false),ne={class:"login-form text-center"},se={key:0},le={key:1},re={class:"hint"},ue={class:"token"},ie={class:"control"},ae={key:0},de={key:1},ce={key:0,class:"error"},pe={class:"control"},_e={key:0,class:"error"},me={class:"control"},J=H({__name:"login-form",setup(d){const o=M(),l=M(),n=M(false);let e=0;async function y(){const a=Date.now();if(a<e)return;const{platform:t,userId:k}=s.value;if(!(!t||!k)){e=a+1e3;try{l.value=await $("login/platform",t,k)}catch(K){o.value=K.message}}}async function x(){const{name:a,password:t}=s.value;try{await $("login/password",a,t)}catch(k){o.value=k.message}}const U=oe();function v(){m.user?L.value=false:U.back()}return(a,t)=>{const k=g("k-button"),K=g("k-tab"),b=g("k-icon"),C=g("el-input");return i(),_("div",ne,[l.value?(i(),_(S,{key:0},[p(m).user?(i(),_("h1",se,t[7]||(t[7]=[r("span",null,"平台账户绑定",-1)]))):(i(),_("h1",le,t[8]||(t[8]=[r("span",null,"平台账户登录",-1)]))),r("p",re,"欢迎你，"+h(l.value.name||"Koishi 用户")+"！",1),t[10]||(t[10]=r("p",{class:"hint"},"请用上述账号将下面的验证码发送给任意正在运行的机器人",-1)),r("p",ue,h(l.value.token),1),r("div",ie,[u(k,{onClick:t[0]||(t[0]=f=>l.value.token=null)},{default:c(()=>t[9]||(t[9]=[w("返回上一步")])),_:1,__:[9]})])],64)):(i(),_(S,{key:1},[p(m).user?(i(),_("h1",ae,t[11]||(t[11]=[r("span",null,"平台账户绑定",-1)]))):(i(),_("h1",de,[u(K,{data:["用户密码登录","平台账户登录"],modelValue:p(s).authType,"onUpdate:modelValue":t[1]||(t[1]=f=>p(s).authType=f)},null,8,["modelValue"])])),p(m).user||p(s).authType===1?(i(),_(S,{key:2},[u(C,{placeholder:"平台名",modelValue:p(s).platform,"onUpdate:modelValue":t[2]||(t[2]=f=>p(s).platform=f)},{prefix:c(()=>[u(b,{name:"at"})]),_:1},8,["modelValue"]),u(C,{placeholder:"账号",modelValue:p(s).userId,"onUpdate:modelValue":t[3]||(t[3]=f=>p(s).userId=f),onKeypress:R(F(y,["stop"]),["enter"])},{prefix:c(()=>[u(b,{name:"user"})]),_:1},8,["modelValue","onKeypress"]),o.value?(i(),_("p",ce,h(o.value),1)):N("v-if",true),r("div",pe,[u(k,{onClick:v},{default:c(()=>t[12]||(t[12]=[w("返回")])),_:1,__:[12]}),u(k,{onClick:y},{default:c(()=>t[13]||(t[13]=[w("获取验证码")])),_:1,__:[13]})])],64)):(i(),_(S,{key:3},[u(C,{placeholder:"用户名",modelValue:p(s).name,"onUpdate:modelValue":t[4]||(t[4]=f=>p(s).name=f)},{prefix:c(()=>[u(b,{name:"user"})]),_:1},8,["modelValue"]),u(C,{placeholder:"密码",modelValue:p(s).password,"onUpdate:modelValue":t[6]||(t[6]=f=>p(s).password=f),onKeypress:R(F(x,["stop"]),["enter"]),type:n.value?"text":"password"},{prefix:c(()=>[u(b,{name:"lock"})]),suffix:c(()=>[u(b,{name:n.value?"eye":"eye-slash",onClick:t[5]||(t[5]=f=>n.value=!n.value)},null,8,["name"])]),_:1},8,["modelValue","onKeypress","type"]),o.value?(i(),_("p",_e,h(o.value),1)):N("v-if",true),r("div",me,[u(k,{onClick:v},{default:c(()=>t[14]||(t[14]=[w("返回")])),_:1,__:[14]}),u(k,{onClick:x},{default:c(()=>t[15]||(t[15]=[w("登录")])),_:1,__:[15]})])],64))],64))])}}}),fe=H({__name:"login",setup(d){return(o,l)=>{const n=g("k-card"),e=g("k-layout");return i(),O(e,{main:"darker page-login"},{default:c(()=>[u(n,null,{default:c(()=>[u(J)]),_:1})]),_:1})}}}),ve={class:"k-schema-header"},ge={class:"k-schema-item"},ke={class:"header"},Ce={class:"left"},ye={class:"right"},we=H({__name:"profile",setup(d){const o={platform:"平台账户",password:"用户密码"},l=M({}),n=T(()=>I.object({name:I.string().description("用户名").default(s.value.name),password:I.string().role("secret").description("密码").default(s.value.password)}).description("基本资料"));async function e(){return m.user=null,delete s.value.id,delete s.value.token,delete s.value.expiredAt,$("user/logout")}async function y(){try{await $("user/update",l.value),z.success("修改成功！"),Object.assign(s.value,l.value),Object.assign(m.user,l.value),l.value={}}catch(v){z.error(v.message)}}const x=T(()=>{var v;return(v=m.user)==null?void 0:v.bindings.filter(a=>m.user.id===a.bid)}),U=T(()=>[{icon:"check",label:"应用更改",disabled:!l.value||!Object.keys(l.value).length,action:y},{type:"danger",icon:"sign-out",label:"退出登录",action:e}]);return(v,a)=>{const t=g("k-form"),k=g("el-button"),K=g("k-content"),b=g("k-layout");return i(),O(b,{main:"page-profile",menu:U.value},{default:c(()=>[u(K,null,{default:c(()=>[u(t,{schema:n.value,modelValue:l.value,"onUpdate:modelValue":a[0]||(a[0]=C=>l.value=C)},null,8,["schema","modelValue"]),r("h2",ve,[a[3]||(a[3]=w(" 平台绑定 ")),u(k,{solid:"",class:"right",onClick:a[1]||(a[1]=C=>L.value=true)},{default:c(()=>a[2]||(a[2]=[w("添加")])),_:1,__:[2]})]),(i(true),_(S,null,W(p(m).user.bindings,({platform:C,pid:f,bid:A})=>(i(),_("div",ge,[r("div",ke,[r("div",Ce,h(C)+" ("+h(f)+")",1),r("div",ye,[x.value.length>1||A!==p(m).user.id?(i(),O(k,{key:0,onClick:F(P=>p($)("user/unbind",C,f),["stop","prevent"])},{default:c(()=>a[4]||(a[4]=[w("解绑")])),_:2,__:[4]},1032,["onClick"])):N("v-if",true)])])]))),256)),a[6]||(a[6]=r("h2",{class:"k-schema-header"},"登录历史",-1)),r("ul",null,[(i(true),_(S,null,W(p(m).user.tokens,({inc:C,type:f,createdAt:A,lastUsedAt:P,address:Q,userAgent:X})=>(i(),_("li",{key:C},[r("div",null,"登录类型："+h(o[f]),1),r("div",null,"登录时间："+h(A),1),r("div",null,"最后访问："+h(P),1),r("div",null,"IP 地址："+h(Q),1),r("div",null,"客户端："+h(X),1),r("div",null,[u(k,{onClick:Je=>p($)("user/delete-token",C)},{default:c(()=>a[5]||(a[5]=[w("移除会话")])),_:2,__:[5]},1032,["onClick"])])]))),128))])]),_:1,__:[6]})]),_:1},8,["menu"])}}}),V=(d,o)=>{const l=d.__vccOpts||d;for(const[n,e]of o)l[n]=e;return l},he={},$e={class:"k-icon k-icon-at",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"};function be(d,o){return i(),_("svg",$e,o[0]||(o[0]=[r("path",{fill:"currentColor",d:"M256 8C118.941 8 8 118.919 8 256c0 137.059 110.919 248 248 248 48.154 0 95.342-14.14 135.408-40.223 12.005-7.815 14.625-24.288 5.552-35.372l-10.177-12.433c-7.671-9.371-21.179-11.667-31.373-5.129C325.92 429.757 291.314 440 256 440c-101.458 0-184-82.542-184-184S154.542 72 256 72c100.139 0 184 57.619 184 160 0 38.786-21.093 79.742-58.17 83.693-17.349-.454-16.91-12.857-13.476-30.024l23.433-121.11C394.653 149.75 383.308 136 368.225 136h-44.981a13.518 13.518 0 0 0-13.432 11.993l-.01.092c-14.697-17.901-40.448-21.775-59.971-21.775-74.58 0-137.831 62.234-137.831 151.46 0 65.303 36.785 105.87 96 105.87 26.984 0 57.369-15.637 74.991-38.333 9.522 34.104 40.613 34.103 70.71 34.103C462.609 379.41 504 307.798 504 232 504 95.653 394.023 8 256 8zm-21.68 304.43c-22.249 0-36.07-15.623-36.07-40.771 0-44.993 30.779-72.729 58.63-72.729 22.292 0 35.601 15.241 35.601 40.77 0 45.061-33.875 72.73-58.161 72.73z"},null,-1)]))}const Ve=V(he,[["render",be]]),xe={},Se={class:"k-icon check",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512"};function ze(d,o){return i(),_("svg",Se,o[0]||(o[0]=[r("path",{fill:"currentColor",d:"M438.6 105.4C451.1 117.9 451.1 138.1 438.6 150.6L182.6 406.6C170.1 419.1 149.9 419.1 137.4 406.6L9.372 278.6C-3.124 266.1-3.124 245.9 9.372 233.4C21.87 220.9 42.13 220.9 54.63 233.4L159.1 338.7L393.4 105.4C405.9 92.88 426.1 92.88 438.6 105.4H438.6z"},null,-1)]))}const Me=V(xe,[["render",ze]]),Le={},Be={class:"k-icon k-icon-lock",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512"};function He(d,o){return i(),_("svg",Be,o[0]||(o[0]=[r("path",{fill:"currentColor",d:"M400 224h-24v-72C376 68.2 307.8 0 224 0S72 68.2 72 152v72H48c-26.5 0-48 21.5-48 48v192c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V272c0-26.5-21.5-48-48-48zm-104 0H152v-72c0-39.7 32.3-72 72-72s72 32.3 72 72v72z"},null,-1)]))}const Ue=V(Le,[["render",He]]),Ke={},je={class:"k-icon k-icon-sign-in",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"};function De(d,o){return i(),_("svg",je,o[0]||(o[0]=[r("path",{fill:"currentColor",d:"M384 256c0-8.188-3.125-16.38-9.375-22.62l-128-128C237.5 96.22 223.7 93.47 211.8 98.44C199.8 103.4 192 115.1 192 128v64H48C21.49 192 0 213.5 0 240v32C0 298.5 21.49 320 48 320H192v64c0 12.94 7.797 24.62 19.75 29.56c11.97 4.969 25.72 2.219 34.88-6.938l128-128C380.9 272.4 384 264.2 384 256zM224 384V288H48C39.18 288 32 280.8 32 272v-32C32 231.2 39.18 224 48 224H224L223.1 128l128 128L224 384zM432 32h-96C327.2 32 320 39.16 320 48S327.2 64 336 64h96C458.5 64 480 85.53 480 112v288c0 26.47-21.53 48-48 48h-96c-8.844 0-16 7.156-16 16s7.156 16 16 16h96c44.13 0 80-35.88 80-80v-288C512 67.88 476.1 32 432 32z"},null,-1)]))}const Ie=V(Ke,[["render",De]]),Oe={},Ae={class:"k-icon k-icon-sign-out",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"};function Te(d,o){return i(),_("svg",Ae,o[0]||(o[0]=[r("path",{fill:"currentColor",d:"M176 448h-96C53.53 448 32 426.5 32 400v-288C32 85.53 53.53 64 80 64h96C184.8 64 192 56.84 192 48S184.8 32 176 32h-96C35.88 32 0 67.88 0 112v288C0 444.1 35.88 480 80 480h96C184.8 480 192 472.8 192 464S184.8 448 176 448zM502.6 233.4l-128-128c-9.156-9.156-22.91-11.91-34.88-6.938C327.8 103.4 320 115.1 320 128l.0918 63.1L176 192C149.5 192 128 213.5 128 240v32C128 298.5 149.5 320 176 320l144.1-.001L320 384c0 12.94 7.797 24.62 19.75 29.56c11.97 4.969 25.72 2.219 34.88-6.938l128-128C508.9 272.4 512 264.2 512 256S508.9 239.6 502.6 233.4zM352 384V288H176C167.2 288 160 280.8 160 272v-32C160 231.2 167.2 224 176 224H352l-.0039-96l128 128L352 384z"},null,-1)]))}const Ee=V(Oe,[["render",Te]]),Ne={},Fe={class:"k-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"};function Pe(d,o){return i(),_("svg",Fe,o[0]||(o[0]=[r("path",{fill:"currentColor",d:"M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256s256-114.6 256-256S397.4 0 256 0zM256 480c-47.24 0-91.04-14.78-127.2-39.84C132.9 390.9 173.8 352 224 352h64c50.25 0 91.14 38.94 95.21 88.16C347 465.2 303.2 480 256 480zM411.7 416.7C397.6 361.3 347.7 320 288 320H224c-59.73 0-109.6 41.3-123.7 96.72C58.27 375.1 32 319 32 256c0-123.5 100.5-224 224-224s224 100.5 224 224C480 319 453.7 375.1 411.7 416.7zM256 128C211.8 128 176 163.8 176 208C176 252.2 211.8 288 256 288s80-35.82 80-80C336 163.8 300.2 128 256 128zM256 256C229.5 256 208 234.5 208 208S229.5 160 256 160s48 21.53 48 48S282.5 256 256 256z"},null,-1)]))}const Re=V(Ne,[["render",Pe]]),We=H({__name:"bind-dialog",setup(d){return(o,l)=>{const n=g("el-dialog");return i(),O(n,{center:"",modelValue:p(L),"onUpdate:modelValue":l[0]||(l[0]=e=>G(L)?L.value=e:null),class:"bind-dialog"},{default:c(()=>[u(J)]),_:1},8,["modelValue"])}}}),qe=H({__name:"sync-dialog",setup(d){const o=q();async function l(n){if(s.value.sync=!!n,D.value=false,!!n){if(n==="download"){o.value=m.user.config;return}try{await $("user/update",{config:o.value})}catch(e){z.error(e.message)}}}return(n,e)=>{const y=g("el-button"),x=g("el-button-group"),U=g("el-dialog");return i(),O(U,{class:"sync-dialog",onClose:e[3]||(e[3]=v=>{var a;return(a=p(o)).sync??(a.sync=false)}),"show-close":false,"close-on-click-modal":false,"close-on-press-escape":false,modelValue:p(D),"onUpdate:modelValue":e[4]||(e[4]=v=>G(D)?D.value=v:null)},{default:c(()=>[e[8]||(e[8]=r("p",{class:"text-center"},"检测到你本地的配置与云端不同步，是否同步配置？",-1)),u(x,{class:"text-center"},{default:c(()=>[u(y,{onClick:e[0]||(e[0]=v=>l("upload"))},{default:c(()=>e[5]||(e[5]=[w("上传当前配置")])),_:1,__:[5]}),u(y,{onClick:e[1]||(e[1]=v=>l("download"))},{default:c(()=>e[6]||(e[6]=[w("下载云端配置")])),_:1,__:[6]}),u(y,{onClick:e[2]||(e[2]=v=>l())},{default:c(()=>e[7]||(e[7]=[w("关闭配置同步")])),_:1,__:[7]})]),_:1})]),_:1,__:[8]},8,["modelValue"])}}}),Ge=V(qe,[["__scopeId","data-v-0bc5f101"]]);B.register("at",Ve);B.register("check",Me);B.register("lock",Ue);B.register("sign-in",Ie);B.register("sign-out",Ee);B.register("user-full",Re);const Ze=d=>{s.value.token&&s.value.expiredAt>Date.now()&&$("login/token",s.value.id,s.value.token).catch(n=>z.error(n.message)),d.on("activity",n=>n.authority>0&&(!m.user||m.user.authority<n.authority)),d.scope.disposables.push(j.beforeEach(n=>{const{activity:e}=n.meta;if(e){if((e.authority||e.fields.includes("user"))&&!m.user)return history.state.forward==="/login"?"/":"/login";if(e.authority&&e.authority>m.user.authority)return z.error("权限不足。"),false}})),d.page({path:"/login",name:"登录",icon:"sign-in",position:"bottom",order:500,disabled:()=>!!m.user,component:fe}),d.page({path:"/profile",name:"用户资料",icon:"user-full",fields:["user"],position:"bottom",order:500,component:we}),d.slot({type:"global",component:We}),d.slot({type:"global",component:Ge}),d.settings({id:"user",title:"用户设置",component:H(()=>()=>te(g("k-form"),{schema:I.object({sync:I.boolean().description("在多个客户端间同步设置。")}).description("同步设置"),initial:s.value,modelValue:s.value,"onUpdate:modelValue":n=>s.value=n}))});const o=q();function l(){ee(m.user.config,o.value)||(D.value=true)}d.on("dispose",E(o,async n=>{!n||!m.user||!s.value.sync||await $("user/update",{config:n})},{deep:true})),d.on("dispose",E(()=>s.value.sync,async n=>{n&&m.user&&l()})),d.on("dispose",E(()=>m.user,(n,e)=>{if(L.value=false,!n)return j.push("/login");if(s.value.sync&&l(),e)return;Object.assign(s.value,Z(n,["id","name","token","expiredAt"])),z.success(`欢迎回来，${n.name||"Koishi 用户"}！`);const y=j.currentRoute.value.redirectedFrom;y&&!y.path.startsWith("/login")?j.push(y):j.push("/profile")}))};export{Ze as default};
