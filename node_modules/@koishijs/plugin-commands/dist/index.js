import{Schema as ce,store as R,useContext as ae,useRpc as te,valueMap as de,clone as me,send as x,deepEqual as pe,pick as X,icons as oe}from"@koishijs/client";import{createElementBlock as H,openBlock as d,createElementVNode as g,defineComponent as I,ref as V,computed as j,watch as se,resolveComponent as _,Fragment as q,createVNode as p,createBlock as $,createCommentVNode as B,unref as E,withCtx as l,createTextVNode as v,renderList as Y,normalizeClass as F,toDisplayString as L,withKeys as Z,withModifiers as ee,nextTick as ne,onActivated as fe,inject as re}from"vue";import{useRoute as ve,useRouter as _e}from"vue-router";import{watchDebounced as Ce}from"@vueuse/core";const W=(a,o)=>{const u=a.__vccOpts||a;for(const[r,i]of o)u[r]=i;return u},ge={},ke={class:"k-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512"};function ye(a,o){return d(),H("svg",ke,o[0]||(o[0]=[g("path",{fill:"currentColor",d:"M368 320H320V192h48C412.2 192 448 156.2 448 112C448 67.82 412.2 32 368 32S288 67.82 288 112V160H160V112C160 67.82 124.2 32 80 32S0 67.82 0 112C0 156.2 35.82 192 80 192H128v128H80C35.82 320 0 355.8 0 400C0 444.2 35.82 480 80 480S160 444.2 160 400V352h128v48c0 44.18 35.82 80 80 80s80-35.82 80-80C448 355.8 412.2 320 368 320zM320 112C320 85.53 341.5 64 368 64S416 85.53 416 112S394.5 160 368 160H320V112zM128 400C128 426.5 106.5 448 80 448S32 426.5 32 400S53.53 352 80 352H128V400zM128 160H80C53.53 160 32 138.5 32 112S53.53 64 80 64S128 85.53 128 112V160zM288 320H160V192h128V320zM368 448c-26.47 0-48-21.53-48-48V352h48c26.47 0 48 21.53 48 48S394.5 448 368 448z"},null,-1)]))}const Ve=W(ge,[["render",ye]]),we={},be={class:"k-icon check",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512"};function he(a,o){return d(),H("svg",be,o[0]||(o[0]=[g("path",{fill:"currentColor",d:"M438.6 105.4C451.1 117.9 451.1 138.1 438.6 150.6L182.6 406.6C170.1 419.1 149.9 419.1 137.4 406.6L9.372 278.6C-3.124 266.1-3.124 245.9 9.372 233.4C21.87 220.9 42.13 220.9 54.63 233.4L159.1 338.7L393.4 105.4C405.9 92.88 426.1 92.88 438.6 105.4H438.6z"},null,-1)]))}const xe=W(we,[["render",he]]),$e={},He={class:"k-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512"};function Se(a,o){return d(),H("svg",He,o[0]||(o[0]=[g("path",{fill:"currentColor",d:"M160 400C160 408.8 152.8 416 144 416C135.2 416 128 408.8 128 400V192C128 183.2 135.2 176 144 176C152.8 176 160 183.2 160 192V400zM240 400C240 408.8 232.8 416 224 416C215.2 416 208 408.8 208 400V192C208 183.2 215.2 176 224 176C232.8 176 240 183.2 240 192V400zM320 400C320 408.8 312.8 416 304 416C295.2 416 288 408.8 288 400V192C288 183.2 295.2 176 304 176C312.8 176 320 183.2 320 192V400zM317.5 24.94L354.2 80H424C437.3 80 448 90.75 448 104C448 117.3 437.3 128 424 128H416V432C416 476.2 380.2 512 336 512H112C67.82 512 32 476.2 32 432V128H24C10.75 128 0 117.3 0 104C0 90.75 10.75 80 24 80H93.82L130.5 24.94C140.9 9.357 158.4 0 177.1 0H270.9C289.6 0 307.1 9.358 317.5 24.94H317.5zM151.5 80H296.5L277.5 51.56C276 49.34 273.5 48 270.9 48H177.1C174.5 48 171.1 49.34 170.5 51.56L151.5 80zM80 432C80 449.7 94.33 464 112 464H336C353.7 464 368 449.7 368 432V128H80V432z"},null,-1)]))}const Me=W($e,[["render",Se]]);function ie(a,o){if(["intersect","union"].includes(a.type))for(const u of a.list)ie(u,o);else if(a.type==="object")for(const u in o)a.dict[u]&&(a.dict[u]=a.dict[u].default(o[u]))}function le(a,o){const u=new ce(R.schema[a]);return o&&ie(u,o),u}const ze={class:"navigation flex flex-wrap gap-x-4 gap-y-2 my-8"},Le={class:"mb-8"},Ee={class:"k-schema-header"},De={class:"text-left"},Oe={class:"text-right"},je={class:"mt-2"},Ne=I({__name:"command",props:{command:{}},setup(a){const o=ae(),u=te(),r=a,i=V(),b=V(),C=V(""),k=V(""),y=V(null),s=V(),D=j({get:()=>typeof y.value=="string",set:()=>y.value=null});se(()=>r.command,n=>{if(!n)return;const{initial:e,override:t}=n;i.value={config:le("command",e.config),options:de(e.options,(f,w)=>le("command-option",e.options[w]))},s.value=me(t)},{immediate:true}),o.action("command.update",{disabled:()=>pe(X(s.value,["config","options"]),X(r.command.override,["config","options"])),action:()=>x("command/update",r.command.name,X(s.value,["config","options"]))});function M(n){const e=s.value.aliases[n];s.value.aliases={[n]:e,...s.value.aliases},x("command/aliases",r.command.name,s.value.aliases)}function G(n){r.command.initial.aliases[n]?s.value.aliases[n].filter=false:delete s.value.aliases[n],x("command/aliases",r.command.name,s.value.aliases)}function h(n){s.value.aliases[n]=r.command.initial.aliases[n],x("command/aliases",r.command.name,s.value.aliases)}function T(n){return[...(n==null?void 0:n.args)||[],...Object.entries((n==null?void 0:n.options)||{}).map(([e,t])=>t===true?`--${e}`:`--${e}=${t}`)].join(" ")}async function J(){var n;await ne(),(n=b.value)==null||n.focus()}const P=j(()=>Object.values(u.value).flatMap(n=>n.override.aliases)),N=j(()=>!C.value||!!P.value[C.value]),U=V({});Ce(k,async n=>{n.trim()&&(U.value=await x("command/parse",r.command.name,k.value))},{debounce:500});async function K(){if(!N.value){if(k.value.trim()){const n=await x("command/parse",r.command.name,k.value);if(n.error)return;s.value.aliases[C.value]=n}else s.value.aliases[C.value]={};await x("command/aliases",r.command.name,s.value.aliases),D.value=false,k.value=""}}return(n,e)=>{const t=_("router-link"),f=_("el-button"),w=_("k-form"),S=_("el-input"),Q=_("el-dialog");return d(),H(q,null,[g("div",ze,[E(R).config&&E(R).packages&&n.command.paths.length?(d(),$(t,{key:0,class:"el-button",to:"/plugins/"+n.command.paths[0].replace(/\./,"/")},{default:l(()=>e[6]||(e[6]=[v("前往插件")])),_:1,__:[6]},8,["to"])):B("v-if",true),E(R).locales?(d(),$(t,{key:1,class:"el-button",to:"/locales/commands/"+n.command.name.replace(/\./,"/")},{default:l(()=>e[7]||(e[7]=[v("前往本地化")])),_:1,__:[7]},8,["to"])):B("v-if",true)]),g("div",Le,[g("h2",Ee,[e[9]||(e[9]=v(" 别名设置 ")),p(f,{class:"float-right mr-4",onClick:e[0]||(e[0]=c=>(C.value=y.value="",k.value=""))},{default:l(()=>e[8]||(e[8]=[v("添加")])),_:1,__:[8]})]),g("table",null,[(d(true),H(q,null,Y(Object.entries(s.value.aliases),([c,m],z)=>(d(),H("tr",{key:c},[g("td",De,[g("span",{class:F(["alias-name",{disabled:(m==null?void 0:m.filter)===false}])},L(c),3),v(" "+L(T(m)?`(${T(m)})`:""),1)]),g("td",Oe,[z>0?(d(),$(f,{key:0,disabled:(m==null?void 0:m.filter)===false,onClick:A=>M(c)},{default:l(()=>[v(L(z>0?"设为默认":"显示名称"),1)]),_:2},1032,["disabled","onClick"])):B("v-if",true),(m==null?void 0:m.filter)!==false?(d(),$(f,{key:1,onClick:A=>G(c)},{default:l(()=>[v(L(n.command.initial.aliases[c]?"禁用":"删除"),1)]),_:2},1032,["onClick"])):(d(),$(f,{key:2,onClick:A=>h(c)},{default:l(()=>e[10]||(e[10]=[v("恢复")])),_:2,__:[10]},1032,["onClick"]))])]))),128))])]),p(w,{schema:i.value.config,initial:n.command.override.config,modelValue:s.value.config,"onUpdate:modelValue":e[1]||(e[1]=c=>s.value.config=c)},{title:l(()=>[e[11]||(e[11]=v("指令设置"))]),_:1,__:[11]},8,["schema","initial","modelValue"]),(d(true),H(q,null,Y(n.command.initial.options,(c,m)=>(d(),$(w,{key:m,schema:i.value.options[m],initial:n.command.override.options[m],modelValue:s.value.options[m],"onUpdate:modelValue":z=>s.value.options[m]=z},{title:l(()=>[v("选项："+L(c.syntax),1)]),_:2},1032,["schema","initial","modelValue","onUpdate:modelValue"]))),128)),p(Q,{class:"command-alias-dialog","destroy-on-close":"",modelValue:D.value,"onUpdate:modelValue":e[5]||(e[5]=c=>D.value=c),title:y.value?"编辑别名":"添加别名",onOpen:J},{footer:l(()=>[p(f,{onClick:e[4]||(e[4]=c=>D.value=false)},{default:l(()=>e[12]||(e[12]=[v("取消")])),_:1,__:[12]}),p(f,{type:"primary",disabled:N.value||!!U.value.error,onClick:K},{default:l(()=>e[13]||(e[13]=[v("确定")])),_:1,__:[13]},8,["disabled"])]),default:l(()=>[g("div",null,[p(S,{ref_key:"inputEl",ref:b,class:F({invalid:N.value}),modelValue:C.value,"onUpdate:modelValue":e[2]||(e[2]=c=>C.value=c),onKeydown:Z(ee(K,["stop","prevent"]),["enter"]),placeholder:"请输入别名"},null,8,["class","modelValue","onKeydown"])]),g("div",je,[p(S,{class:F({invalid:U.value.error}),modelValue:k.value,"onUpdate:modelValue":e[3]||(e[3]=c=>k.value=c),onKeydown:Z(ee(K,["stop","prevent"]),["enter"]),placeholder:"请输入参数 (可选)"},null,8,["class","modelValue","onKeydown"])])]),_:1},8,["modelValue","title"])],64)}}}),Ue=W(Ne,[["__scopeId","data-v-169fe827"]]),Ke={class:"search"},Be=I({__name:"commands",setup(a){const o=ve(),u=_e(),r=ae(),i=te(),b=V(),C=V(""),k=V(null),y=V(""),s=V(null),D=j(()=>{const e={...i.value};for(const f in i.value)for(const w of i.value[f].children)delete e[w];function t(f){return f.sort().map(w=>{const S=i.value[w];return{...S,children:t(S.children)}})}return t(Object.keys(e))}),M=V(false);async function G(){var e;await ne(),(e=b.value)==null||e.focus()}se(y,e=>{k.value.filter(e)});const h=j({get(){const e=o.path.slice(10).replace(/\//g,".");return e in i.value?e:""},set(e){e in i.value||(e=""),u.replace("/commands/"+e.replace(/\./g,"/"))}});function T(e){const t=[];return e.name===h.value&&t.push("is-active"),t.join(" ")}function J(e,t){return t.name.toLowerCase().includes(y.value.toLowerCase())}function P(e){return!e.data.name.includes(".")}function N(e,t,f){return e.parent!==(f==="inner"?t:t.parent)}function U(e){h.value=e.name}function K(e,t,f,w){const S=f==="inner"?t:t.parent;x("command/teleport",e.data.name,S.data.name)}async function n(){await x("command/create",C.value),C.value="",M.value=false}return fe(async()=>{const e=s.value.$el;await ne();const t=e.querySelector(".el-tree-node.is-active");t&&s.value.setScrollTop(t.offsetTop-(e.offsetHeight-t.offsetHeight)/2)}),r.action("command.create",{action:()=>M.value=true}),r.action("command.remove",{disabled:()=>{var e;return!((e=i.value[h.value])!=null&&e.create)},action:()=>x("command/remove",i.value[h.value].name)}),(e,t)=>{const f=_("k-icon"),w=_("el-input"),S=_("el-tree"),Q=_("el-scrollbar"),c=_("k-content"),m=_("k-empty"),z=_("el-button"),A=_("el-dialog"),ue=_("k-layout");return d(),$(ue,{menu:"command"},{header:l(()=>[v(" 指令管理"+L(h.value?" - "+h.value:""),1)]),left:l(()=>[p(Q,{class:"command-tree w-full h-full overflow-auto",ref_key:"root",ref:s},{default:l(()=>[g("div",Ke,[p(w,{modelValue:y.value,"onUpdate:modelValue":t[0]||(t[0]=O=>y.value=O)},{suffix:l(()=>[p(f,{name:"search"})]),_:1},8,["modelValue"])]),p(S,{ref_key:"treeEl",ref:k,draggable:true,data:D.value,props:{label:"name",class:T},"filter-node-method":J,"default-expand-all":true,"expand-on-click-node":false,"allow-drag":P,"allow-drop":N,onNodeClick:U,onNodeDrop:K},null,8,["data","props"])]),_:1},512)]),default:l(()=>[h.value?(d(),$(c,{key:0,class:"command-config"},{default:l(()=>[p(Ue,{command:E(i)[h.value]},null,8,["command"])]),_:1})):(d(),$(m,{key:1},{default:l(()=>t[4]||(t[4]=[g("div",null,"请在左侧选择指令",-1)])),_:1,__:[4]})),p(A,{class:"command-dialog","destroy-on-close":"",modelValue:M.value,"onUpdate:modelValue":t[3]||(t[3]=O=>M.value=O),title:"添加指令",onOpen:G},{footer:l(()=>[p(z,{onClick:t[2]||(t[2]=O=>M.value=false)},{default:l(()=>t[5]||(t[5]=[v("取消")])),_:1,__:[5]}),p(z,{type:"primary",disabled:!C.value,onClick:n},{default:l(()=>t[6]||(t[6]=[v("确定")])),_:1,__:[6]},8,["disabled"])]),default:l(()=>[p(w,{ref_key:"inputEl",ref:b,class:F({invalid:!C.value}),modelValue:C.value,"onUpdate:modelValue":t[1]||(t[1]=O=>C.value=O),onKeydown:Z(ee(n,["stop","prevent"]),["enter"]),placeholder:"请输入名称"},null,8,["class","modelValue","onKeydown"])]),_:1},8,["modelValue"])]),_:1})}}}),Te={key:0,class:"navigation flex flex-wrap gap-x-4 gap-y-2 my-8"},Ae=I({__name:"locales",setup(a){const o=re("locale:prefix");return(u,r)=>{const i=_("router-link");return E(o)&&E(o).startsWith("commands.")?(d(),H("div",Te,[p(i,{class:"el-button",to:"/commands/"+E(o).slice(9).replace(/\./,"/")},{default:l(()=>r[0]||(r[0]=[v("前往指令")])),_:1,__:[0]},8,["to"])])):B("v-if",true)}}}),Re=I({__name:"settings",setup(a){const o=re("manager.settings.current"),u=te(),r=j(()=>Object.values(u.value).filter(i=>i.paths.includes(o.value.path)).sort((i,b)=>i.name.localeCompare(b.name)));return(i,b)=>{const C=_("router-link"),k=_("k-comment");return r.value.length?(d(),$(k,{key:0,type:"success"},{default:l(()=>[b[0]||(b[0]=g("p",null,"此插件提供了下列指令：",-1)),g("ul",null,[(d(true),H(q,null,Y(r.value,y=>(d(),H("li",{key:y.name},[p(C,{to:"/commands/"+y.name.replace(/\./g,"/")},{default:l(()=>[v(L(y.name),1)]),_:2},1032,["to"])]))),128))])]),_:1,__:[0]})):B("v-if",true)}}});oe.register("activity:commands",Ve);oe.register("check",xe);oe.register("trash-can",Me);const Ge=a=>{a.page({path:"/commands/:name*",name:"指令管理",icon:"activity:commands",order:500,authority:4,component:Be}),a.slot({type:"plugin-details",component:Re,order:200}),a.slot({type:"locale-main",component:Ae,order:1e3}),a.menu("command",[{id:".update",icon:"save",label:"保存更改"},{id:".remove",icon:"trash-can",label:"移除指令"},{id:".create",icon:"add",label:"创建指令"}])};export{Ge as default};
